#### 在Linux服务器上使用tcpdump命令进行抓包

由于Linux上没有wireshark之类的抓包工具，所以我们要使用tcpdump命令行来进行抓包，举个例子：

```shell
########################################################
# nohup								# 在后台运行        #
# -i eth0							# 指定网卡			#
# tcp 								# 抓取TCP报文		#
# port 9090 						# 抓取9090端口 		#
# -w ./tcpdump.pcap		 			# 将数据写入文件	  #
#########################################################
nohup tcpdump -i eth0 -vnn tcp and port 9090 -w ./tcpdump.pcap &
```



#### tcpdump安装

```shell
yum install -y tcpdump
```



#### tcpdump命令行选项

| 选项  | 说明                                                         |
| ----- | ------------------------------------------------------------ |
| -a    | 将网络地址和广播地址转变成名字                               |
| -A    | 以ASCII格式打印出所有分组，并将链路层的头最小化              |
| -b    | 数据链路层上选择协议，包括ip/arp/rarp/ipx都在这一层          |
| -c    | 指定收取数据包的次数，即在收到指定数量的数据包后退出tcpdump  |
| -d    | 将匹配信息包的代码以人们能够理解的汇编格式输出               |
| -dd   | 将匹配信息包的代码以c语言程序段的格式输出                    |
| -ddd  | 将匹配信息包的代码以十进制的形式输出                         |
| -D    | 打印系统中所有可以监控的网络接口                             |
| -e    | 在输出行打印出数据链路层的头部信息                           |
| -f    | 将外部的Internet地址以数字的形式打印出来，即不显示主机名     |
| -F    | 从指定的文件中读取表达式，忽略其他的表达式                   |
| -i    | 指定监听网卡                                                 |
| -l    | 使标准输出变为缓冲形式，可以数据导出到文件                   |
| -L    | 列出网络接口已知的数据链路                                   |
| -n    | 不把网络地址转换为名字                                       |
| -N    | 不输出主机名中的域名部分，例如www.baidu.com只输出www         |
| -nn   | 不进行端口名称的转换                                         |
| -P    | 不将网络接口设置为混杂模式                                   |
| -q    | 快速输出，即只输出较少的协议信息                             |
| -r    | 从指定的文件中读取数据，一般是-w保存的文件                   |
| -w    | 将捕获到的信息保存到文件中，且不分析和打印在屏幕             |
| -s    | 从每个组中读取在开始的snaplen个字节，而不是默认的68个字节    |
| -S    | 将tcp的序列号以绝对值形式输出，而不是相对值                  |
| -T    | 将监听到的包直接解析为指定的类型的报文，常见的类型有rpc（远程过程调用）和snmp（简单网络管理协议） |
| -t    | 在输出的每一行不打印时间戳                                   |
| -tt   | 在每一行中输出非格式化的时间戳                               |
| -ttt  | 输出本行和前面以后之间的时间差                               |
| -tttt | 在每一行中输出data处理的默认格式的时间戳                     |
| -u    | 输出未解码的NFS句柄                                          |
| -v    | 输出稍微详细的信息，例如在ip包中可以包括ttl和服务类型的信息  |
| -vv   | 输出详细的保报文信息                                         |



#### tcpdump表达式

表达式是一个正则表达式，tcpdump利用它作为过滤报文的条件，如果一个报文满足表达式的条件，则这个报文将会被捕获。如果没有给出任何条件，则网络上所有的信息包 将会被截获，在表达式中一般如下几种类型的关键字：

##### type

>   ```
>   主要用来区分过滤报文源类型，主要由host主机报文，net网段报文和port指定端口的报文组成
>   ```

| 类型  | 说明     | 示例                            |
| ----- | -------- | ------------------------------- |
| host  | 主机的IP | tcpdump host 192.168.56.150     |
| net   | 网络地址 | tcpdump net 192.168.0.0         |
| port  | 端口     | tcpdump port 8080               |
| ether | MAC地址  | tcpdump ether 00:16:3e:06:74:a8 |

##### dir

>   ```
>   只过滤报文的源地址和目的地址，主要包括src源地址和dst目的地址
>   ```

| 类型        | 说明       | 示例                            |
| ----------- | ---------- | ------------------------------- |
| src         | 来源       | tcpdump src host 192.168.56.150 |
| dst         | 目标       | tcpdump det host 192.168.56.101 |
| dst or src  | 来源或目标 | tcpdump dst or src port 8080    |
| dst and src | 来源且目标 | tcpdump dst and src port 8080   |

##### proto

>   ```
>   只过滤报文的协议类型，支持tcp，udp和icmp等；使用的时候可以省略proto关键字
>   ```

| 类型 | 示例         |
| ---- | ------------ |
| ip   | tcpdump ip   |
| arp  | tcpdump arp  |
| rarp | tcpdump rarp |
| tcp  | tcpdump tcp  |
| udp  | tcpdump udp  |

##### 条件组合

>   包含与、或、非

| 类型 | 示例                                                         |
| ---- | ------------------------------------------------------------ |
| or   | tcpdump ether src 00:16:3e:06:74:a8 or ether dst 00:16:3e:06:74:a8 |
| and  | tcpdump ether src 16:82:3a:06:74:69 and ether dst 00:16:3e:06:74:a8 |
| not  | tcpdump ip not 192.168.56.101                                |



#### tcpdump示例

##### 指定网络接口

>   如果不指定网卡，默认tcpdump只会监视第一个网络接口，一般是eth0

```shell
##### eth0：网卡名称，可以通过ifconfig || ip addr命令查看
tcpdump -i eth0
```

##### 指定IP

-   指定IP

    ```shell
    tcpdump host {IP}
    ```

-   指定IP的接收

    ```shell
    tcpdump dst host {IP} 
    ```

-   指定IP的发送

    ```shell
    tcpdump src host {IP}
    ```

-   指定IP_1的接收和指定IP_2的发送

    ```shell
    tcpdump host dst {IP_1} and host src {IP_2}
    ```

-   指定IP_1与IP_2之间的通信

    ```shell
    tcpdump host {IP_1} and {IP_2}
    ```

    