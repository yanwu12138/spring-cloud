### DSCP与IP优先级

>   在`IPv4`的报文头中，`TOS`字段是1字节。既是下图中的区分服务（报文的第二个字节）。
>`TOS`即为服务类型，只有当**网络设备能够支持**（能够识别`IP`首部中的`TOS`字段）识别`TOS`字段时，这给字段设置才有意义。否则都是空谈。
>   `TOS`的前`6`个`bit`位为`DSCP`的值（默认为`000 000`）；后`2`个`bit`位为`ECN`的值（默认为`00`）。
>通过设置`DSCP`的值可以针对IP设置其优先级。

![image-20201123151517764](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/2020112315151717.png)



#### IP优先级

根据`RFC1122`的定义，`IP`优先级（`IP Precedence`）使用最高`3`个`bit`位（第`0~2bit`）来表示。可区分`8`种流量的优先级，定义如下：

![image-20210519173653457](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2021/05/2021051917365353.png)

| 级别 | 描述                           |
| ---- | ------------------------------ |
| 111  | Network Control  网络控制      |
| 110  | Internetwork Control  网间控制 |
| 101  | Critic  关键                   |
| 100  | Flash Override  疾速           |
| 011  | Flash  闪速                    |
| 101  | Immediate 快速                 |
| 001  | Priority 优先                  |
| 000  | Routine 普通                   |

-   优先级6和7一般保留给网络控制数据使用，比如路由。
-   优先级5推荐给语音数据使用。
-   优先级4由视频会议和视频流使用。
-   优先级3给语音控制数据使用。
-   优先级1和2给数据业务使用。
-   优先级0为缺省标记值。

#### DSCP

`DSCP`由`RFC2474`定义，它重新命名了`IPv4`报头中`TOS`使用的那`1`字节和`IPv6`报头中数据类（`TrafficClass`）那`1`字节，新的名字称为`DS`字段（`Differentiated Services Field`）。该字段的作用没有变，仍然被`QoS`工具用来标记数据。不同的是`IPv4`使用`3`比特，而`DSCP`使用`6`比特。

`RFC2474`定义最高`3bit`为 级别/类别选择代码（`ClassSelector Codepoints，CS`），其意义和`IPv4`报头中`IP`优先级的定义是相同的，`CS0～CS7`的级别相等于`IP`优先级`0～7`。但它并没有定义第`3`到第`5`比特的具体含义以及使用规则。

`DSCP`使用`6bit`，**最后一位（即第`5bit`）恒为0**，共定义了`4`大类和`21`小类类别。

`4`大类分别为：`AF`、`EF`、`CS`、`default`

##### AF

>   保证转发（`Assured Forwarding，WAF`）由`RFC2597`对`CS1~CS4`进行进一步定义（`0-2`位不为`0`，`3-5`位也必须不为`0`），前`3bit`为优先级位，越大优先级越高，后`3bit`为丢弃位，越大优先级越低。它使用第`3`和第`4`比特做丢弃优先级标志。`01`：低丢弃优先级；`10`：中丢弃优先级；`11`：高丢弃优先级。这样，在同一类数据中，又根据被丢弃的可能性划分出`3`档。
>
>   | AF   | DESP    |
>   | ---- | ------- |
>   | AF11 | 001 010 |
>   | AF12 | 001 100 |
>   | AF13 | 001 110 |
>   | AF21 | 010 010 |
>   | AF22 | 010 100 |
>   | AF23 | 010 110 |
>   | AF31 | 011 010 |
>   | AF32 | 011 100 |
>   | AF33 | 011 110 |
>   | AF41 | 100 010 |
>   | AF42 | 100 100 |
>   | AF43 | 100 110 |

##### EF

>   无阻碍转发（`Expedited Forwarding，EF`）由`RFC2598`定义，`DSCP`值为`46(101110)`。EF服务适用于低丢包率，低延迟，低抖动及保证带宽的业务

##### CS

>   向后兼容IP优先级，取值为1-7，作用和IP优先级完全相同
>
>   | CS   | DSCP    |
>   | ---- | ------- |
>   | CS1  | 001 000 |
>   | CS2  | 010 000 |
>   | CS3  | 011 000 |
>   | CS4  | 100 000 |
>   | CS5  | 101 000 |
>   | CS6  | 110 000 |
>   | CS7  | 111 000 |

##### default

>   `DSCP = 000000` 尽力转发服务

#### IP优先级和DSCP对照表

![image-20210519174846797](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2021/05/2021051917484646.png)

#### [ENC](https://blog.csdn.net/xxx_500/article/details/8584323)

