### IP协议

> 规定网络地址的协议叫IP协议，它定义的地址称之为IP地址，它是一个__网络层__协议，它的上层是传输层协议，它的下层是链路层协议，IP协议是面向非连接的，所谓的非连接就是在数据的传递过程中，不需要检测网络是否连通，所以是不可靠的数据报协议。IP协议主要用于在主机之间的寻址和选择数据包路由。所以IP协议不保证数据的可靠性。

#### IP协议的特点

1.  IP协议是一种无连接的不可靠的分组传送服务协议，因此它提供的是一种尽力而为的服务

    1.  无连接：IP协议不维护IP分组发送后的任何状态信息
    2.  不可靠：IP协议不能保证每个IP分组都正的、不丢失和顺序的到达目的主机

2.  IP协议是点到点的网路层通信协议

    IP协议是针对 源主机 >> 路由器、路由器 >> 路由器、路由器 >> 目标主机之间的数据传输的点-点的网络层通信协议，它为两台通信主机寻找一条路径，通常多个路由器、点-点线路组成

3.  IP协议屏蔽了互联的网络在数据链路层、物理层协议与实现技术上的差异

    ![image-20201123151158850](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/2020112315115858.png)

#### IP协议可能遇到的问题

- 封包损坏：数据在传输的过程中发生了损坏
- 丢包：数据在传输的过程中丢失
- 重发：数据在传输的过程中，被某个路由节点发送到了不同的链路，且最后两个封包都到达了目标，此时会发生重复
- 乱序：数据到达目标的顺序与发送的顺序不一致

#### IP协议的工作原理

- 分片：接收上层传输层Host-To-Host协议传来的数据，然后进行拆分

- 增加协议头：会为每个分片再增加一个IP的头部（IP Header）
- 传输数据：调用下层链路层进行传输数据
- 寻址：怎么通过一个IP地址找到对应的设备
- 路由：通过路由算法决定数据的传输过程

#### 传输过程中的问题

- 延迟：1bit的数据从网络的一个终端传送到另一个终端需要的时间
- 吞吐量：单位时间内可以传输的平均数据量
- 丢包率：发送出去的封包没有到达目的地的比例



### IPV4

IPV4协议规定网络地址由32位2进制表示，其取值范围0.0.0.0~255.255.255.255

#### IPV4 协议头

![image-20201123151517764](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/2020112315151717.png)

###### 版本号

>    4位，就是IP协议的版本，通信双方的IP协议必须要达到一致，IPv4的版本就是4.

###### 首部长度

>   4位，因为长度为四比特，所以首部长度的最大值为1111，15，又因为首部长度代表的单位长度为32个字（也就是4个字节），所以首部长度的最小值就是0101，当然，也确实如此，大部分的ip头部中首部字节都是0101.也就是5*4=20个字节，如果是最大值15的话，ip首部的最大值就是60个字节，所以记好了，ipv4首部长度的最大值就是60，当然当中我们又能发现，IPv4的首段长度一定是4字节的整数倍，要是不是怎么办呢？别急，后面的填充字段会自动填充补齐到4字节的整数倍的。

###### [服务类型（区分服务）](./010 DSCP与IP优先级.md)

>   8位，用于**指示路由器如何处理这些IP分组**，由4位的服务类型字段，3位的优先级字段和1位保留位构成
>
>   -   服务类型字段
>       用4个参数指示路由器如何处理IP分组，分别是：
>       延迟（D），可靠性（R），吞吐量（T），成本（C），每一位都有0或者1的取值
>   -   优先级
>       当高负荷情况下，路由器发生阻塞，优先级越高的IP分组越优先被路由器处理

###### 总长度

>   16位，这个的意思就是ip数据报中首部和数据的总和的长度，因为占16位，所以很好理解，总长度的最大值就是2的16次方减一，65535，这玩意也对应着还有一个很简单的概念，最大传输单元mtu，意味着一个IP数据报的最大长度就只能装下65535个字节，要是传输的长度超过这个怎么办，很简单，分片。

###### 标识

>   16位，标识这玩意很好理解，IP在存储器中维持一个计数器，每产生一个 数据报，计数器就加1,并将此值赋给标识字段。但这个标识并不是平常的序号，因为IP是 无连接服务，数据报不存在按序接收的问题。当数据报由于长度超过网络的MTU而必须分 片时，这个标识字段的值就被复制到所有的数据报片的标识字段中，等到重组的时候，相同标识符的值的数据报就会被重新组装成一个数据报。

###### 标志

>   3位，一般有用的是前两位:
>
>   最低位叫做MF，MF=1表示后面还有若干个数据报，MF=0表示这已经是最后一个数据报了。
>
>   中间位叫做DF，DF表示不能进行分片，DF=0才可以进行分片操作。

###### 偏移量（片偏移）

>   13位，片偏移就是，在原来的数据报分片以后，该片在原分组中的相对位置，片偏移中的基本单位是8字节，所以，也就是说，只要是分片，每个分片的长度都是8字节的整数倍，最后一个分片不够八字节的一样是填充。

###### 生存时间

>   8位，表明数据报在网络中的寿命，这个值被设定成跳数，顾名思义，就是这个数据报可以经过多少个路由器的数量，每经过一个路由器，该值就减一，减到为零的时候就被抛弃，显而易见，这个跳数的最大值就是2的8次方减一：255。

###### 协议

>   8位，就是用来指明数据报携带了哪种协议。

###### 首部校验和

>   16位，用来效验数据报首段，下面给出简单的计算方法：![image-20201123153009112](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/202011231530099.png)
>
>   首先在发送端的时候，将效验和全部置为0，然后把数据报首段数据全部进行反码相加，得到的值为效验和，放入首段效验和里面，然后接收端将数据报首段数据和效验和一起全部反码相加，最后若是得到零，则保留，若是不为零，则说明数据报在传输的过程中发生了改变，则丢弃该数据报。

###### 源IP

>   32位，将IP地址看作是32位数值则需要将网络字节顺序转化位主机字节顺序。转化的方法是：将每4个字节首尾互换，将2、3字节互换。

###### 目标IP

>   32位，转换方法和来源IP地址一样。

#### IP地址

##### IP地址和MAC地址的区别

-   MAC地址是每块网卡的硬件地址，用于数据链路层的帧传递地址；IP地址是网络层地址（也称逻辑地址），用于路由器寻址
-   IP地址标识的是**一台主机或路由器 与 网络的接口**，而MAC地址唯一地标识一台主机
-   网桥，Ethernet交换机属于数据链路层设备，使用MAC地址，不属于网络层设备，所以不分配IP

##### IP地址的分配概念

IP地址的分配可以分下面3种情况：

-   为每一个网络接口分配一个IP地址：一台计算机连入网络，需分配一个IP地址，与MAC地址一一对应，且在Internet中唯一的
-   为多归属主机的每一个网络接口分配响应的IP地址：路由器通过多个网卡连接到多个网络时，需为每个网卡分配一个IP地址
-   可以为一个网络接口分配多个IP地址

##### IP点分十进制表示方法

IPv4的地址长度为32位，点分十进制表示通常采用 x. x. x. x的格式，每个x为8位。（点分十进制从字面上理解，用点分隔，每个字段用十进制表示）

IP地址的分类有5中分类：A类，B类，C类，D类和E类地址，A类保留给政府机构，B类分配给中等规模的公司，C类分配给任何需要的人，D类用于组播，E类用于实验，各类可容纳的地址数目不同

![image-20201123155102083](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/202011231551022.png)

网络号：用于识别主机所在的网络

主机号：用于识别该网络中的主机

###### A类地址

1.  A类地址网络号第一位固定为0，其它7位可以分配，主机号长度为24位
2.  网络号分配的数量为2^7 = 128，地址范围为：**1**.0.0.0 ~ **127**.255.255.255
3.  **10**.0.0.0 ~ **10**.255.255.255是**私有地址**（所谓的私有地址就是在互联网上不使用，而被用在局域网络中的地址，路由器接收到私有地址，不会向Internet转发该分组，私有地址与NAT相关）
4.  **127**.0.0.0 ~ **127**.255.255.255是**保留地址**，用做循环测试用的
5.  **0**.0.0.0 ~ **0**.255.255.255也保留用作特殊用途
6.  因此网络号可分配的只有125个，每个网络段的主机号可以分配的只有 2^24-2=16777214个（**主机号全0和主机号全1保留**）

###### B类地址

1.  B类地址网络号第1,2位固定为10，其它14位可以分配，主机号长度为16位
2.  地址范围为：**128.0**.0.0 ~ **191.255**.255.255
3.  **172.16**.0.0 ~ **172.31**.255.255是**私有地址**
4.  **169.254**.0.0 ~ **169.254**.255.255是**保留地址**（如果你的IP地址是自动获取IP地址，而你在网络上又没有找到可用的DHCP服务器。就会得到其中一个IP
5.  每个网络段可分配的主机号为2^16 - 2 = 65534（**主机号全0和主机号全1保留**）

###### C类地址

1.  C类地址网络号前3位固定为110，其它21位可以分配，主机号长度为8位
2.  C类地址范围：**192.0.0**.0 ~ **223.255.255**.255
3.  **192.168.0**.0 ~ **192.168.255**.255是**私有地址**
4.  网络号可分配的块数为2^21 = 2097152，没块网络号可分配的主机号数为2^8-2 = 254(**主机号全0和主机号全1保留**)

###### D类地址

D类IP地址不标志网络，前4位固定为1110，地址范围为：**224.0.0.0 ~ 239.255.255.255**，用作特殊用途，如多播地址

###### E类地址

E类地址不分网络地址和主机地址，它的第1个字节的前四位固定为1111。E类地址范围：**240.0.0.0 ~ 255.255.255.255**，用于某些实验和将来使用

###### 总结上述的规律

1.  ABC三类地址的主机号全0和全1都保留，主机号全1为子网广播地址，主机号全0为子网网络地址（一个网段中第一个IP地址为网络地址）
2.  A类地址的第1块网络号和第2块网络号要保留

###### ABC三类地址中的特殊IP地址

1.  直接广播地址
    如果主机号全1，例如**191.1**.255.255，那么这个地址为直接广播地址，路由器将这个分组以广播的形式发送到网络号位**191.1**.x.x的全部主机
2.  受限广播地址
    网络号与主机号的32位全为1（255.255.255.255）为受限广播地址，用来将一个分组以广播方式发送给本网的所有主机
3.  “这个网络上的特定主机”地址
    网络号是全0 （如0.0.0.25） 的地址是这个网络号的特定主机地址，路由器接到这样的分组，不向外转发，而是直接交付给本网络中主机号为25的主机
4.  回送地址
    A类地址中127.0.0.0是回送地址，它是一个保留地址

#### IPV4地址的子网划分

子网划分的思想：**借用主机号的一部分作为子网的子网号**，划分出更多的子网IP地址，对于外网来说这些子网仍然像一个网络一样，这对于路由器的寻址没有影响

##### 子网地址结构

1.  标准的ABC类IP地址是两级结构：**网络号—主机号**，而划分子网后，IP地址的结构为三级结构：**网络号—子网号—主机号**
2.  同一个子网的主机，网络号和子网号必须相同
3.  子网之间的距离必须很近，例如一个公司或者校园内

##### 子网掩码

引入子网后，如何从IP地址中提取出子网号？子网掩码就是用来解决这个问题的
子网掩码的作用：从一个IP地址中提取出子网号
子网掩码的表示：**网络号和子网号**全改为1，主机号全改为0

![image-20201123165628164](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/2020112316562828.png)

##### 子网的规划和地址划分的方法

例：一个校园网要对一个B类地址（156.26.0.0）进行子网划分。该校园网有近210个局域网组成。
由于210个局域网最接近2^8=256，所以可行的方案是从主机号借8位来作为子网号，这样的子网的掩码为：255.255.255.0 或 156.26.0.0/22（**”/22“表示第22位开始为主机号**）

以上子网划分结果为：
子网1:156.26.**1**.1~156.26.**1**.254
子网2:156.26.**2**.1~156.26.**2**.254
……
子网254:156.26.**254**.1~156.26.**254**.254

至于子网0：156.26.**0**.1 ~ 156.26.**0**.254 和子网 254：156.26.**255**.1 ~ 156.26.**255**.254，即子网号是否能够为全0或者全1，值得商榷！

由于**主机号不能全为1或者全为0**，每个子网的主机号有254个

子网长度的确定，应考虑两个因素：**子网数**与每个子网中**主机与路由器数**。子网数要考虑留有一定余量为原则

##### 可变长度的子网掩码划分方法

用一个例子来说明：
某公司申请一个C类202.60.31.0的IP地址，该公司有100名员工在销售部，50名在财务部，50名在设计部。要求为销售部门、财务部门、设计部门分别组建子网

__分析：__

三个部门是三个子网，我们很容易想到，只需要借出2位来作为子网号就行。但是借了2位后，主机号只剩下6位，则每一个子网的最大主机号为2^6 = 64个，小于销售部门的100个主机，所以行不通！

这时，可以采用可变长度的子网掩码划分方法：
（1）销售部100台主机，所以主机号至少为7位，则子网号为1位，此时子网掩码：255.255.255.128（11111111.11111111.11111111.1000000）或202.60.31.0/25（第25位开始为主机号）
**子网位为0**：202.60.31.1（**0** 000 0001）~ 202.60.31.126（**0** 111 1110） （作为销售部子网）
**子网位为1**： 202.60.31.129（**1** 000 0001）~ 202.60.31.254（**1** 111 1110）

（2）对子网位为1的情况，再划分出两个子网给财务部门和设计部门，剩下的两个部门只需要6个主机号，所以可以用2位作为子网号，子网掩码为255.255.255.192（11111111.11111111.11111111.1100000）或202.60.31.0/26（第26位开始为主机号）
**子网位为10**：202.60.31.129（**10** 00 0001）~ 202.60.31.190 （**10** 11 1110）（作为财务部子网）
**子网位为11**：202.60.31.193（**11** 00 0001）~ 202.60.31.254（**11** 11 1110）（作为设计部子网）

#### CIDR（无类别域间路由）

>   其实在上述博文中，已经不经意间提到了CIDR，例如156.26.0.0/16
>   CIDR其实讲得是IP地址的格式问题，标准的IP地址的点分十进制是**网络号—主机号**的二层结构，而CIDR用区别于传统标准分类的IP地址与划分子网的概念的“网络前缀（network -prefix）”，用”**<网络前缀>/<主机号>**“代替**网络号—主机号**的二层结构，形成新的无分类二层地址结构
>
>   <网络前缀>/<主机号>这种格式为：”斜线记法“。如：200.16.23.0/20表前20位为网络前缀，后12位为主机号
>
>   同标准的分类IP地址一样，主机号全0的网络地址和全1的广播地址不分配给主机

##### CIRD的应用

例如：一个校园网获得200.24.16.0/20的地址块，希望将它划分为8个等长的较小的地址块

![image-20201123173817803](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/2020112317381717.png)

#### 网络地址转换NAT

>   NAT的作用有两个：
>
>   1.  解决网络地址短缺，支持IP地址复用
>   2.  网络安全
>
>   例如在企业内部，NAT和代理服务器、防火墙结合使用，采用一个内部专用IP和一个全局IP一对一的静态映射，达到隐藏内部网络地址的目的

##### IP地址复用原理

NAT技术解决IP地址短缺，主要用于ISP，ADSL，有线电视和无线移动接入的动态IP地址分配

__原理：__
例如ISP有1000个全局IP地址，但是它有5000个使用专网内部专用IP的用户。
ISP在具有NAT功能的路由器中保持一个IP地址池，管理着多个全局IP地址。凡是需要访问外部Internet的用户，首先想NAT路由器申请，由NAT临时分配一个全局IP地址给用户；用户访问结束后，NAT路由器收回IP地址，供其他用户使用。

之前提到过一个私有地址，所谓的私有地址就是在互联网上不使用，而被用在局域网络中的地址，路由器接收到私有地址，不会向Internet转发该分组，**那么主机该如何通过私有地址和Internet进行通信？**

**NAT就是私有地址和全局地址转换的功能！**

解决全局IP地址不够用：连端口号一起转换！

NAT的有动态NAT和静态NAT两种
**“静态NAT”**：一对一，配置一个内部专用IP地址对应一个公用IP地址。
**“动态NAT”**：多对多，多个专业IP地址对应一个或几个全局IP地址。可实现IP地址的重用节约IP地址。如：ISP有1000个全局地址，但它有5000个使用专用内部专网IP地址的用户。

##### NAT的工作原理

![image-20201123174046705](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/2020112317404646.png)

**私有地址为10.0.1.1的主机如何访问地址为135.2.1.1的web服务器？**

1.  产生一个源地址为10.0.1.1，端口为3342，目的地址为135.2.1.1，端口号为80的ip分组，转发到NAT功能的路由器
2.  NAT路由器将私有地址转换成全局IP地址202.0.1.1，产生一个源地址为202.0.1.1，端口为5001，目的地址为135.2.1.1，端口号为80的ip分组
3.  地址为135.2.1.1，端口号为80的web服务器接收到该IP分组后，，返回源地址为135.2.1.1，端口号为80，目的地址为202.0.1.1，端口为5001为80的ip分组
4.  NAT路由器将全局IP地址转换成私有地址，产生源地址为135.2.1.1，端口号为80，目的地址为10.0.1.1，端口为3342的ip分组，主机10.0.1.1接受

##### NAT的潜在问题

由于NAT（NAPT）都依赖于自己的转换表，所以会有一下问题：

1.  无法从NAT外部向内部服务器建立连接
2.  转换表的生成和转换操作都会产生一定的开销
3.  通信过程中一旦NAT发生异常需要重新启动时，所有的TCP连接都会被重置
4.  即便备置两台NAT做容灾备份，TCP连接还是会被断开

### IPV6

>   IPv6地址采用”冒号十六进制表示法“，将128位地址按每16位划分为一个位段，每个位段转换为一个4位的十六进制数
>
>   例如：
>   二进制：
>   00100001 11011010 00000000 00000000 00000000 00000000 00000000 00000000
>   00000010 10101010 00000000 00001111 11111110 00001000 10011100 01011010
>
>   1.  冒号十六进制表示法：
>       21DA : 0000 : 0000 : 0000 : 02AA : 000F : FE08 : 9C5A
>
>   2.  如果某段存在几位都是0的情况，可以使用零压缩法压缩：
>
>       `零压缩法：00D3（D3），02AA（2AA），000A（A），0000（0），但是AB08不能压缩为AB8`
>
>       21DA : 0 : 0 : 0 : 2AA : F : FE08 : 9C5A
>
>   3.  如果存在几个连续位段都是0，可以用”双冒号表示法“
>       21DA : ：2AA : F : FE08 : 9C5A
>       用”双冒号表示法“表示的一个问题：如何确定冒号省略的段数？
>       `8 - 现有段数 = 冒号省略的段数`

#### IPV6协议头

在IPv4中，子网掩码用来表示网络和子网地址长度。用前缀长度来区分子网号和主机号。而 **IPv6不支持子网掩码，只支持前缀长度表示法，用“地址/前缀长度”表示**

64位前缀是一个子网前缀，少于64位的前缀是一个路由前缀，或是一个地址范围。
例如：
21DA：D3：：/48 是一个路由前缀
21DA：D3：0：2：2F3B：：/64是一个子网前缀

![image-20201123154241252](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/11/2020112315424141.png)

1.  取消了首部长度，因为IPv6的首部长度是固定40个字节。
2.  取消了服务类型，因为流标号和优先级结合起来实现了服务类型的功能。
3.  取消了总长度字段，改用为有效载荷长度，有效载荷就是后面的扩展首部加上数据报中的数据。
4.  取消了标识，标志和片偏移，因为这些功能都包含在了扩展首部里面。
5.  取消了协议字段，改用为下一个首部，功能不变，这样更容易理解。
6.  取消了生存时间ttl，改用为跳数限制，功能不变，这样更容易理解，更形象了。
7.  取消了首部效验和，这样加快了路由器对数据报的处理速度，在数据链路层中，当我们发现有差错的帧就会抛弃，在运输层中，在udp中，当发现有差错就会抛弃，在tcp中，当发现有差错就会重传，直到传送到目的进程为止。因此在网路层的检测就可以精简掉。
8.  取消了选项字段，功能归并在了扩展首部上。

###### 版本

>   意义和IPv4相同，值为6表示使用Ipv6协议

###### 通信量类

>   表示IPv6分组的类型或优先级，类似IPv4的服务类型字段

###### 流标号

>   表示分组属于源节点和目标节点之间的一个特定分组序列

###### 有效荷载长度

>   载荷长度表示有效载荷的长度，包括扩展报头和高层PDU

###### 下一个报头

>   表示若存在扩展报头，“下一个报头”值表示下一个扩展报头的类型

###### 跳步限制

>   与IPv4的TTL相似

###### 源地址与目标地址

>   发送主机的地址和要发送的目标主机地址







___参考___

https://blog.csdn.net/qq_42058590/article/details/82918678

https://blog.csdn.net/jeffleo/article/details/53933937