#### 什么是Zookeeper

Zookeeper是集群分布式中大管家

分布式集群系统比较复杂，子模块很多，但是子模块往往不是孤立存在的，它们彼此之间需要协作和交互，各个子系统就好比动物园里的动物，为了使各个子系统能正常为用户提供统一的服务，必须需要一种机制来进行协调——这就是ZooKeeper

Zookeeper 是为分布式应用程序提供高性能协调服务的工具集合，也是Google的Chubby一个开源的实现，是Hadoop 的分布式协调服务。

#### Zookeeper的集群结构

![image-20210122153832148](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2021/01/2021012215383232.png)

在ZooKeeper集群当中，集群中的服务器角色有两种：1个Leader和多个Follower，具体功能如下：

1.  leader：领导者，负责进行投票的发起和决议，监控集群中的(follower)是否存活（心跳机制），进行分配资源

2.  follower用于接受客户端请求并向客户端返回结果，在选主过程中参与投票

__特点：__

-   Zookeeper：一个leader，多个follower组成的集群

-   全局数据一致：每个server保存一份相同的数据副本，client无论连接到哪个server，数据都是一致的

-   数据更新原子性，一次数据更新要么成功，要么失败

-   实时性，在一定时间范围内，client能读到最新数据

-   半数机制：整个集群中只要有一半以上存活，就可以提供服务。因此通常Zookeeper由2n+1台servers组成，每个server都知道彼此的存在。每个server都维护的内存状态镜像以及持久化存储的事务日志和快照。为了保证Leader选举能过得到多数的支持，所以ZooKeeper集群的数量一般为奇数。对于2n+1台server，只要有n+1台（大多数）server可用，整个系统保持可用

#### Zookeeper的leader选主机制

##### 全新集群

假设有五台服务器组成的zookeeper集群,它们的id从1-5,同时它们都是最新启动的,也就是没有历史数据,在存放数据量这一点上,都是一样的.假设这些服务器依序启动,来看看会发生什么.

1.  服务器1启动,此时只有它一台服务器启动了,它发出去的报没有任何响应,所以它的选举状态一直是LOOKING状态
2.  服务器2启动,它与最开始启动的服务器1进行通信,互相交换自己的选举结果,由于两者都没有历史数据,所以id值较大的服务器2胜出,但是由于没有达到超过半数以上的服务器都同意选举它(这个例子中的半数以上是3),所以服务器1,2还是继续保持LOOKING状态.
3.   服务器3启动,根据前面的理论分析,服务器3成为服务器1,2,3中的老大,而与上面不同的是,此时有三台服务器选举了它,所以它成为了这次选举的leader.
4.   服务器4启动,根据前面的分析,理论上服务器4应该是服务器1,2,3,4中最大的,但是由于前面已经有半数以上的服务器选举了服务器3,所以它只能接收当小弟的命了.
5.   服务器5启动,同4一样,当小弟.

##### 非全新集群

那么，初始化的时候，是按照上述的说明进行选举的，但是当zookeeper运行了一段时间之后，有机器down掉，重新选举时，选举过程就相对复杂了。

需要加入数据id、leader id和逻辑时钟。

-   数据id：数据新的id就大，数据每次更新都会更新id。

-   Leader id：就是我们配置的myid中的值，每个机器一个。

-   逻辑时钟：这个值从0开始递增,每次选举对应一个值,也就是说:  如果在同一次选举中,那么这个值应该是一致的 ;  逻辑时钟值越大,说明这一次选举leader的进程最新.

选举的标准与规则为：

1.  逻辑时钟小的选举结果被忽略，重新投票
2.  统一逻辑时钟后，数据id大的胜出
3.  数据id相同的情况下，leader id大的胜出

#### Zookeeper的作用

Zookeeper包含一个简单的原语集，分布式应用程序可以基于它实现命名服务、配置维护、集群选主等：

-   命名服务：注册节点信息，形成有层次的目录结构（类似Java的包名）。

-   配置维护：配置信息的统一管理和动态切换

-   集群选主：确保整个集群中只有一个主，其它为从。并且当主挂了后，可以从新选主