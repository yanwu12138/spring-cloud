## [操作系统启动过程](http://www.ruanyifeng.com/blog/2013/02/booting.html)

>   操作系统启动过程可以简单划分为四个部分：BIOS、主记录引导、硬盘启动、操作系统；其中每个部分又可以划分为多个子部分。



### BIOS

>   BIOS（Basic Input/Output System）是基本输入/输出系统的简称。BIOS能为计算机提供最低级、最直接的硬件控制与支持，是联系最底层的硬件系统和软件系统的桥梁，为了在关机后是BIOS不会丢失，早期的BIOS存储在ROM（Read-only memory）中，并且其大小不会超过64K；而目前的BIOS大多有1M~2M，所以会被存储在闪存中。

#### BIOS最要的作用

-   CPU加电后首先会执行BIOS程序，其中POST（Power-On Self-Tset）加电自检程序实质性的第一个例行程序，主要是对CPU、内存等硬件设备进行检测和初始化。
-   BIOS中断调用：即BIOS中断服务程序，是计算机系统软、硬件之间的一个可编程接口。开机时，BIOS会通知CPU各种硬件设备的中断号，并且提供中断服务程序。软件可以通过调用BIOS中断对软盘驱动器、键盘及显示器等外围设备进行管理。
-   BIOS会根据在CMOS中保存的配置信息来判断使用哪种设备的启动操作系统，并将CPU移交给操作系统使用。

#### BIOS过程

-   硬件自检（POST）

    >   BIOS程序首先检查，计算机硬件是否满足运行的基本条件，这叫做硬件自检（Power-On Self-Tset）,缩写为POST。如果硬件出现问题，计算机主板会发出不同含义的蜂鸣，中止启动。如果没有问题，屏幕则会显示CPU、内存、硬件等信息。
    >
    >   ![image-20201021152021542](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/10/2020102115202121.png)

-   启动顺序

    >   硬件自检完成后，BIOS把控制权移交给下一阶段的启动程序。
    >
    >   这时，BIOS需要知道，“下一阶段的启动程序”具体存放在哪一个设备。即BIOS需要有一个外部存储设备的排序，排在前面的设备就是优先移交控制权的设备。这种排序就叫做：启动顺序。如果找到，则将存储设备中的引导扇区读入物理内存的0x7C00处，并跳转到0x7C00继续执行，从而将CPU交给引导扇区中的Boot程序。
    >
    >   打开BIOS的操作界面，其中就有一项是设定启动顺序：
    >
    >   ![image-20201021152154428](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/10/2020102115215454.png)



### 主引导记录

>   BIOS按照启动顺序把控制权交给排在第一位的存储设备。这是计算机读取该设备的第一个扇区，即读取最前面的512字节。如果这512字节的最后两个字节是0x55,0xAA，则表明这个设备可以用于启动；如果不是，则表明该设备不能用于启动。控制权被移交给启动顺序中的下一个设备。
>
>   这最前面的512字节被称为主引导记录（MBR：Master boot record）。

#### 主引导记录的结构

>   主引导记录只有512字节，它的主要作用是告诉计算机到硬盘的哪一个位置去找操作系统， 其由三个部分组成：
>
>   | 字节    | 说明                         |
>   | ------- | ---------------------------- |
>   | 1~446   | 调用操作系统的机器码         |
>   | 447~510 | 分区表                       |
>   | 511~521 | 主引导记录签名（0x55, 0xAA） |

#### 分区表

>    由于硬盘可以分区，且每个区可以安装不同的操作系统，因此主引导记录必须知道将控制权移交给哪个区。
>
>   分区表的长度只有64个字节，这64字节又分为4项，每项16字节，所以一块硬盘最多只能分出4个一级分区，又叫做主分区。
>
>   每个主分区的16个字节由6个部分组成：
>
>   | 字节  | 说明                                                         |
>   | ----- | ------------------------------------------------------------ |
>   | 1     | 如果为0x80，就表示该主分区是激活分区，控制权要转交给这个分区。四个主分区里面只能有一个是激活的 |
>   | 2~4   | 主分区第一个扇区的物理位置（柱面、磁头、扇区号等等）         |
>   | 5     | 主分区类型                                                   |
>   | 6~8   | 主分区最后一个扇区的物理位置                                 |
>   | 9~12  | 主分区第一个扇区的逻辑地址                                   |
>   | 13~16 | 主分区的扇区总数                                             |
>
>   最后的四个字节（"主分区的扇区总数"），决定了这个主分区的长度。也就是说，一个主分区的扇区总数最多不超过2的32次方。
>
>   如果每个扇区为512个字节，就意味着单个分区最大不超过2TB。再考虑到扇区的逻辑地址也是32位，所以单个硬盘可利用的空间最大也不超过2TB。如果想使用更大的硬盘，只有2个方法：一：是提高每个扇区的字节数，二：是增加扇区总数。



### 硬盘启动

>   这时，计算机的控制权就要转交给硬盘的某个分区了，这里又分成三种情况。

#### 卷引导记录

>   上面提到，四个主分区里面，只有一个是激活的。计算机会读取激活分区的第一个扇区，叫做"卷引导记录"（Volume boot record，缩写为VBR）。
>
>   "卷引导记录"的主要作用是，告诉计算机，操作系统在这个分区里的位置。然后，计算机就会加载操作系统了。

#### 扩展分区和逻辑分区

>   随着硬盘越来越大，四个主分区已经不够了，需要更多的分区。但是，分区表只有四项，因此规定有且仅有一个区可以被定义成"扩展分区"（Extended partition）。
>
>   所谓"扩展分区"，就是指这个区里面又分成多个区。这种分区里面的分区，就叫做"逻辑分区"（logical partition）。
>
>   计算机先读取扩展分区的第一个扇区，叫做"扩展引导记录"（Extended boot record，缩写为EBR）。它里面也包含一张64字节的分区表，但是最多只有两项（也就是两个逻辑分区）。
>
>   计算机接着读取第二个逻辑分区的第一个扇区，再从里面的分区表中找到第三个逻辑分区的位置，以此类推，直到某个逻辑分区的分区表只包含它自身为止（即只有一个分区项）。因此，扩展分区可以包含无数个逻辑分区。
>
>   但是，似乎很少通过这种方式启动操作系统。如果操作系统确实安装在扩展分区，一般采用下一种方式启动。

#### 启动管理器

>   在这种情况下，计算机读取"主引导记录"前面446字节的机器码之后，不再把控制权转交给某一个分区，而是运行事先安装的"启动管理器"（boot loader），由用户选择启动哪一个操作系统。
>
>   Linux环境中，目前最流行的启动管理器是Grub。



### 操作系统

>   控制权转交给操作系统后，操作系统的内核首先被载入内存。
>
>   以Linux系统为例，先载入/boot目录下面的kernel。内核加载成功后，第一个运行的程序是/sbin/init。它根据配置文件（Debian系统是/etc/initab）产生init进程。这是Linux启动后的第一个进程，pid进程编号为1，其他进程都是它的后代。
>
>   然后，init线程加载系统的各个模块，比如窗口程序和网络程序，直至执行/bin/login程序，跳出登录界面，等待用户输入用户名和密码。
>
>   至此，全部启动过程完成。
>
>   ![image-20201021155352540](https://typroa12138.oss-cn-hangzhou.aliyuncs.com/image/2020/10/2020102115535252.png)

